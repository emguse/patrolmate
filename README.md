# PatrolMate

工場向け巡回点検記録を行うための、バニラJavaScript製PWAプロトタイプです。オフライン環境でも巡回リストの確認と記録ができ、安定した通信環境で端末内の記録を「同期済み」として締める運用を想定しています。

## 主な機能

- 巡回台帳（サンプルデータ）を事前ロードして端末にキャッシュ
- 担当者・日付・巡回属性を設定すると対応する巡回リストを生成
- 現地で読み取ったコード値の記録（手入力）
- 結果は端末の `localStorage` に保存され、同期ボタンで「同期済み」フラグを付与
- Service Worker による静的アセットのキャッシュとオフライン動作

## 開発者向け情報

### フロントエンドのみを動作させる場合

1. 任意の静的サーバでプロジェクトルートを配信してください。
   ```bash
   npx serve .
   ```
2. 初回アクセス時に Service Worker が登録され、台帳データとアセットがキャッシュされます。
3. オフラインに切り替えても巡回リストの参照と記録が可能です。
4. 同期ボタンは端末内の未同期データに同期日時を記録し、「同期済み」バッジへ更新します（ネットワーク送信は行いません）。

### モックサーバーを併用する場合

1. 依存パッケージをインストールします。
   ```bash
   npm install
   ```
2. モックサーバーを起動します。
   ```bash
   npm start
   ```
   デフォルトでは [http://localhost:5173](http://localhost:5173) で静的ファイルとAPIを提供します。
3. ブラウザでアクセスすると、静的アセットと同じ内容の台帳が `/api/ledger` からも取得できます（参照用）。
4. 同期ボタンを押した際のペイロードを確認したい場合は、`assets/app.js` の同期処理をモックサーバー向けに拡張して `/api/sync` へ送信してください。リクエストを受けると `server/sync-log.json` に追記され、`/api/sync-log` で参照できます。

## データの構造

- `data/ledger.json`: 巡回属性と巡回項目のサンプルデータ
- `codex/ledger.codex.json`: 外部ツール取り込み用に整形した巡回台帳エクスポート
- `codex/README.md`: Codex エクスポートのフォーマット説明
- `server/sync-log.json`: モックサーバーが受信した同期データ（存在しない場合は自動で作成）
- `localStorage`:
  - `patrolmate-ledger`: 台帳データのキャッシュ
  - `patrolmate-session`: 前回の巡回設定
  - `patrolmate-results`: 巡回結果の保存および同期状態（`synced` と `syncedAt` を付与）

## Codex エクスポート

`codex/ledger.codex.json` は、巡回台帳を外部システムや Codex ワークフローに転用できるよう再構成した JSON です。`sessionFields` で端末が要求する入力項目を、`checklists` で巡回属性ごとのタスクとスキャンコードを定義しています。詳細は [`codex/README.md`](codex/README.md) を参照してください。

## PWA 対応

- `manifest.json`: アプリのメタデータおよびアイコン定義（🛡️アイコンはインラインSVGのBase64データURIで提供）
- `service-worker.js`: キャッシュ戦略（静的アセットの事前キャッシュ + オンデマンドキャッシュ）

なお、本プロトタイプは最低限の機能に留めており、実運用に際しては認証、詳細な同期処理、バックエンド連携などを追加実装してください。
